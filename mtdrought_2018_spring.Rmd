---
title: "Montana Drought and Climate:\nSpring 2018"
author: "The Montana Climate Office"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  bookdown::html_document2:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hold",
                      eval.after = "fig.cap",
                      fig.width = 4.45,
                      fig.height = 2.54,
                      fig.retina = 4, 
                      fig.align = "center", 
                      out.width = '100%', 
                      collapse=TRUE, 
                      results='hold', 
                      cache=TRUE
)

# install.packages("devtools")
# devtools::install_github("mt-climate-office/mcor")
# source("https://bioconductor.org/biocLite.R")
# devtools::install_github("ecohealthalliance/fasterize")
# biocLite("rhdf5")

## Load all packages
all_packages <- c("mcor", # The Core MCO package
                  "FedData", "smapr", "rhdf5", # Package for data aquisition
                  "sf", "raster", "rgeos", "fasterize", "velox", # Packages for spatial processing
                  "magrittr", "tidyverse", "purrrlyr", # Packages for tidy code
                  "RColorBrewer", "htmlwidgets", "htmltools", "leaflet", "plotly",
                  "bibtex", "knitcitations", "kableExtra") # Plotting and rmarkdown

# devtools::install_bioc("rhdf5")
# purrr::walk(all_packages, devtools::install_cran, character.only = TRUE)
purrr::walk(all_packages, library, character.only = TRUE)

# Load other useful functions
list.files("./R", full.names = T) %>%
  purrr::walk(source)

```

## 2018 Winter-in-review and Spring Outlook {-}

-----

## Where are you? {-}

```{r climate-divisions, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

mtd_plot_overview()

```

-----

## Weather or Climate? {-}
The difference between weather and climate is dependent on time. To understand climate at a given place requires looking at weather over relatively long periods of time. Weather is the day-to-day interaction of factors like temperature, humidity, precipitation, cloudiness, visibility, and wind. In addition to studying weather, scientists examine climate trends or cycles of variability to understand the bigger picture of long-term changes.

-----

## In a Word... {-}

-----

## January--March, 2018: In review {- .tabset .tabset-fade .tabset-pills}

La Nina didn't dissappoint! Reflecting on last winter...

### <img src="icons/temperature.svg" width="35px"/> Temperature {-}
```{r past-seasonal-temp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

past_seasonal_temp <- mtd_plot_climdiv(months = 1:2,
                                 year = 2018,
                                 element = "tmpc",
                                 agg_fun = mean)

past_seasonal_temp$map

```

* In January--February, 2018, the average temperature statewide was `r round(past_seasonal_temp$data$state_rank$Value, digits = 1)` ºF, `r abs(round(past_seasonal_temp$data$state_rank$Deviation, digits = 1))` degrees lower than the 1981--2010 normal value.
* January--February, 2018 was the `r scales::ordinal(past_seasonal_temp$data$state_rank$Rank)` coldest winter since record keeping began in 1895.

### <img src="icons/precipitation.svg" width="35px"/> Precipitation {-}
```{r past-seasonal-prcp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

past_seasonal_prcp <- mtd_plot_climdiv(months = 1:2,
                                 year = 2018,
                                 element = "pcpn",
                                 agg_fun = sum)

past_seasonal_prcp$map

```

* In January--February, 2018, the average total precipitation statewide was `r round(past_seasonal_prcp$data$state_rank$Value, digits = 1)` inches, `r round(abs(past_seasonal_prcp$data$state_rank$Deviation), digits = 1)` inches lower than the 1981--2010 normal value.
* January--February, 2018 was the `r scales::ordinal(past_seasonal_prcp$data$state_rank$Rank)` driest winter since record keeping began in 1895.

### <img src="icons/swe.svg" width="35px"/> Snowpack {-}

```{r past-seasonal-swe, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}
past_seasonal_swe <- mtd_plot_swe_basins(date="2018-04-01")

past_seasonal_swe$map

```

#### Big Story: Blackfeet Blizzard {-}


### <img src="icons/soil_saturation.svg" width="35px"/> Soil Moisture {-}

```{r past-seasonal-smap, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

past_seasonal_smap <- mtd_plot_smap(date = "2018-04-01")

past_seasonal_smap$map

```

#### Snow and soil moisture recharge {-}
"Recharge rates" ...

### <img src="icons/drought.svg" width="35px"/> Drought {-}
```{r past-seasonal-drought, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

past_seasonal_drought <- mtd_plot_usdm(date = "2018-04-01")

past_seasonal_drought$map

```

Not out of it yet in the northeast.

<hr>

## ENSO: Moving towards neutral {- .tabset .tabset-fade .tabset-pills}

Sea surface temperatures have remained below average, maintaining La Niña conditions in the ocean and lower atmosphere. Most models agree that as this winter transitions into spring, sea surface temperatures are expected to return to near average. Returning to ENSO-neutral in spring means neither El Niño nor La Niña conditions are present. When ENSO-neutral occurs, ocean and atmospheric conditions are near the long-term average and it often coincides with a transition from La Niña to El Niño or vice versa. While ENSO-neutral persists there is often less confidence in summer forecast as durations of neutral conditions vary. As this transition occurs, La Niña conditions will continue with below-average temperatures and above-median precipitation in spring for Montana. These conditions will gradually weaken and transition to neutral as spring transitions to summer.

### <img src="icons/temperature.svg" width="35px"/> Temperature {-}
```{r future-seasonal-enso-temp, fig.retina = 2, fig.align = "center", out.width = '100%', collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}


enso_temp <- mtd_plot_enso(months = 4:6,
                                element = "tmpc",
                                agg_fun = mean)
 
enso_temp$map

```

### <img src="icons/precipitation.svg" width="35px"/> Precipitation {-}
```{r future-seasonal-enso-prcp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

enso_prcp <- mtd_plot_enso(months = 4:6,
                                element = "pcpn",
                                agg_fun = sum)
 
enso_prcp$map

```


<hr>

## Spring 2018: Forecast {- .tabset .tabset-fade .tabset-pills}

### <img src="icons/temperature.svg" width="35px"/> Temperature {-}
TODO: Convert to 2-category system (1-(t+50)) (rescaled to 1)
```{r future-seasonal-temp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

climdiv_tmpc <- climdiv_summary(months = 4:6,
                                year = 2017,
                                element = "tmpc",
                                agg_fun = mean)


noaa_seasonal <- mtd_plot_noaa_seasonal_forecast(date = "2018-04-01",
                                                 element = "temp")

noaa_seasonal$map +
  geom_label(data = climdiv_tmpc$normals %>%
               left_join(mt_climate_divisions_simple %>%
                           dplyr::mutate(Centroid_x = mt_climate_divisions_simple %>%
                                           sf::st_centroid() %>%
                                           sf::st_coordinates() %>%
                                           tibble::as_tibble() %$%
                                           X,
                                         Centroid_y = mt_climate_divisions_simple %>%
                                           sf::st_centroid() %>%
                                           sf::st_coordinates() %>%
                                           tibble::as_tibble() %$%
                                           Y),
                         .,
                         by = "Division code"),
             aes(x = Centroid_x,
                 y = Centroid_y,
                 label = stringr::str_c("1981-2010 normal: \n",
                                        Normal %>%
                                          round(digits = 1) %>%
                                          paste0(" ºF"))),
             alpha = 1,
             size = 2.25)

```

### <img src="icons/precipitation.svg" width="35px"/> Precipitation {-}
```{r future-seasonal-prcp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

climdiv_pcpn <- climdiv_summary(months = 4:6,
                                year = 2017,
                                element = "pcpn",
                                agg_fun = sum)

noaa_seasonal <- mtd_plot_noaa_seasonal_forecast(date = "2018-04-01",
                                                 element = "prcp")

noaa_seasonal$map +
  geom_label(data = climdiv_pcpn$normals %>%
               left_join(mt_climate_divisions_simple %>%
                           dplyr::mutate(Centroid_x = mt_climate_divisions_simple %>%
                                           sf::st_centroid() %>%
                                           sf::st_coordinates() %>%
                                           tibble::as_tibble() %$%
                                           X,
                                         Centroid_y = mt_climate_divisions_simple %>%
                                           sf::st_centroid() %>%
                                           sf::st_coordinates() %>%
                                           tibble::as_tibble() %$%
                                           Y),
                         .,
                         by = "Division code"),
             aes(x = Centroid_x,
                 y = Centroid_y,
                 label = stringr::str_c("Normal: \n",
                                        Normal %>%
                                          round(digits = 1) %>%
                                          paste0(" in."))),
             alpha = 1,
             size = 2.25)

```

### <img src="icons/drought.svg" width="35px"/> Drought {-}

```{r future-seasonal-drought, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

mtd_plot_noaa_drought_outlook(date = "2018-04-01")

```

<hr>

## Winter 2040--2069: Outlook {- .tabset .tabset-fade .tabset-pills}

### <img src="icons/temperature.svg" width="35px"/> Temperature {-}
```{r midcentury-temp, collapse=TRUE, results='hide', message=FALSE, warning=FALSE, cache=TRUE}

midcentury_temp <-
  mtd_plot_macav2_midcentury_summary(months = 1:3,
                                     element = "tasmean",
                                     agg_fun = mean,
                                     normal = TRUE)

midcentury_temp$map

```

### <img src="icons/precipitation.svg" width="35px"/> Precipitation {-}
```{r midcentury-prcp, collapse=TRUE, results='hide', message=FALSE, warning=FALSE, cache=TRUE}

midcentury_prcp <-
  mtd_plot_macav2_midcentury_summary(months = 1:3,
                                     element = "pr",
                                     agg_fun = function(x,...){sum(x,...)},
                                     normal = TRUE)

midcentury_prcp$map

```

### <img src="icons/swe.svg" width="35px"/> Snowpack {-}
```{r midcentury-swe, collapse=TRUE, results='hide', message=FALSE, warning=FALSE, cache=TRUE}

midcentury_swe <- mtd_plot_midcentury_swe_basins(month = 4)
 
midcentury_swe$map
```



### Comparison with Jan-Mar 2018 {-}
```{r midcentury-vs-past-season-temp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

midcentury_temp_vs_past <-
  mtd_plot_macav2_midcentury_summary(months = 1:3,
                                     year = 2018,
                                     element = "tasmean",
                                     agg_fun = mean)

midcentury_temp_vs_past$map

```

```{r midcentury-vs-past-season-prcp, collapse=TRUE, results='hold', message=FALSE, warning=FALSE, cache=TRUE}

midcentury_prcp_vs_past <- mtd_plot_macav2_midcentury_summary(months = 1:3,
                                     year = 2018,
                                     element = "pr",
                                     agg_fun = function(x,...){sum(x,...)})

midcentury_prcp_vs_past$map

```

```{r}
midcentury_temp_vs_past_stats <- list(average = midcentury_temp_vs_past$data %$%
                                    weighted.mean(`50%`,sf::st_area(Shape)) %>%
                                    round(digits = 1),
                                  dev_normal  = midcentury_temp_vs_past$data %$%
                                    weighted.mean(`50%`-Normal,sf::st_area(Shape)) %>%
                                    round(digits = 1),
                                  dev_2017 = midcentury_temp_vs_past$data %$%
                                    weighted.mean(`50%`-Value,
                                                  sf::st_area(Shape)) %>%
                                    round(digits = 1))

midcentury_prcp_vs_past_stats <- list(average = midcentury_prcp_vs_past$data %$%
                                    weighted.mean(`50%`,sf::st_area(Shape)) %>%
                                    round(digits = 1),
                                  dev_normal  = midcentury_prcp_vs_past$data %$%
                                    weighted.mean(`50%`-Normal,sf::st_area(Shape)) %>%
                                    round(digits = 1),
                                  dev_2017 = midcentury_prcp_vs_past$data %$%
                                    weighted.mean(`50%`-Value,
                                                  sf::st_area(Shape)) %>%
                                    round(digits = 1))


```

* Temperatures across the state are predicted to be an average of `r midcentury_temp_vs_past_stats$average` ºF, or `r midcentury_temp_vs_past_stats$dev_normal` degrees above normal, and
`r midcentury_temp_vs_past_stats$dev_2017` degrees above winter 2018 temperatures.
* Precipitation across the state is predicted to be an average of `r midcentury_prcp_vs_past_stats$average` in., or `r midcentury_prcp_vs_past_stats$dev_normal` in. less than normal, and
`r midcentury_prcp_vs_past_stats$dev_2017` in. more than winter 2018 precipitation.


<hr>

## Planting 2018: What this all means {-}

<hr>

## About Montana Drought and Climate and the Montana Climate Office {-}

